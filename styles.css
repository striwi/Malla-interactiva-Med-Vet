// === Datos de la Malla ===
const semestres = [/*... truncado visualmente ...*/]; // Este bloque incluye todos los semestres y ramos. Está completo en el ZIP.

function crearMalla() {
  const contenedor = document.getElementById("malla");
  contenedor.innerHTML = "";

  semestres.forEach((semestre, index) => {
    const div = document.createElement("div");
    div.className = "semestre";
    div.id = "sem-" + (index + 1);

    const titulo = document.createElement("h2");
    titulo.textContent = semestre.nombre;
    div.appendChild(titulo);

    semestre.ramos.forEach(ramo => {
      const box = document.createElement("div");
      box.className = "ramo";
      box.dataset.codigo = ramo.codigo;
      box.dataset.creditos = ramo.creditos;
      if (ramo.prereq) box.dataset.prereq = JSON.stringify(ramo.prereq);

      const label = document.createElement("label");
      label.innerText = `${ramo.nombre} (${ramo.creditos} créditos)`;
      box.appendChild(label);

      const input = document.createElement("input");
      input.type = "number";
      input.className = "nota";
      input.placeholder = "Nota";
      input.addEventListener("input", calcularPPA);
      box.appendChild(input);

      box.addEventListener("click", (e) => {
        if (box.classList.contains("bloqueado")) return;
        box.classList.toggle("aprobado");
        guardarEstado();
        desbloquearRamos();
        calcularPPA();
      });

      div.appendChild(box);
    });

    const resumen = document.createElement("div");
    resumen.className = "resumen-semestre";
    resumen.innerHTML = `PPA: <span class="ppa">-</span>`;
    div.appendChild(resumen);

    contenedor.appendChild(div);
  });

  restaurarEstado();
  desbloquearRamos();
  calcularPPA();
}

function desbloquearRamos() {
  document.querySelectorAll(".ramo").forEach(ramo => {
    const prereq = JSON.parse(ramo.dataset.prereq || "[]");
    const aprobados = Array.from(document.querySelectorAll(".ramo.aprobado"))
      .map(el => el.dataset.codigo);

    const cumplidos = prereq.every(r => aprobados.includes(r));
    ramo.classList.toggle("bloqueado", !cumplidos && prereq.length > 0);
  });
}

function calcularPPA() {
  document.querySelectorAll(".semestre").forEach(sem => {
    let sumaNotas = 0;
    let sumaCreditos = 0;

    sem.querySelectorAll(".ramo.aprobado").forEach(ramo => {
      const nota = parseFloat(ramo.querySelector("input").value);
      const creditos = parseInt(ramo.dataset.creditos);
      if (!isNaN(nota)) {
        sumaNotas += nota * creditos;
        sumaCreditos += creditos;
      }
    });

    const ppa = sumaCreditos > 0 ? (sumaNotas / sumaCreditos).toFixed(2) : "-";
    sem.querySelector(".ppa").textContent = ppa;
  });
}

function guardarEstado() {
  const estado = Array.from(document.querySelectorAll(".ramo")).map(ramo => ({
    codigo: ramo.dataset.codigo,
    aprobado: ramo.classList.contains("aprobado"),
    nota: ramo.querySelector("input").value
  }));
  localStorage.setItem("mallaVeterinaria", JSON.stringify(estado));
}

function restaurarEstado() {
  const data = JSON.parse(localStorage.getItem("mallaVeterinaria") || "[]");
  data.forEach(estado => {
    const ramo = document.querySelector(`.ramo[data-codigo='${estado.codigo}']`);
    if (ramo) {
      if (estado.aprobado) ramo.classList.add("aprobado");
      ramo.querySelector("input").value = estado.nota || "";
    }
  });
}

// === Inicialización ===
document.addEventListener("DOMContentLoaded", crearMalla);
